<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0a0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Chord Generator - Modern Progression Tool</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --accent: #6366f1;
      --accent-glow: rgba(99, 102, 241, 0.3);
      --accent-hover: #818cf8;
      --text-primary: #f0f0f5;
      --text-secondary: #8888a0;
      --text-muted: #555566;
      --border: #2a2a3a;
      --success: #22c55e;
      --warning: #f59e0b;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 30px 0;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    /* Main Controls */
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .control-group {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .control-group label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .control-group select,
    .control-group input {
      width: 100%;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .control-group select:hover,
    .control-group input:hover {
      border-color: var(--accent);
    }

    .control-group select:focus,
    .control-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    /* Chord Display */
    .chord-display {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .chord-display-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chord-display-title {
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .progression-info {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .chords-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
    }

    .chord-card {
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px 16px;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .chord-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .chord-card.active {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.15);
      box-shadow: 0 0 20px var(--accent-glow);
      transform: scale(1.05);
    }

    .chord-card .chord-name {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .chord-card .chord-type {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .chord-card .beat-indicator {
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      margin: 8px auto 0;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .chord-card.active .beat-indicator {
      opacity: 1;
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.5); }
    }

    /* Transport Controls */
    .transport {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--accent);
    }

    .btn-icon {
      width: 20px;
      height: 20px;
    }

    /* Sound Settings */
    .sound-settings {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .settings-title {
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 16px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .slider-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .slider-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .slider-value {
      font-size: 0.875rem;
      color: var(--accent);
      font-weight: 600;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 10px var(--accent-glow);
    }

    /* Toggle Switches */
    .toggle-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .toggle-group:last-child {
      border-bottom: none;
    }

    .toggle-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .toggle {
      position: relative;
      width: 48px;
      height: 26px;
      background: var(--bg-tertiary);
      border-radius: 13px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .toggle.active {
      background: var(--accent);
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .toggle.active::after {
      transform: translateX(22px);
    }

    /* Visualizer */
    .visualizer {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      height: 120px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 3px;
      overflow: hidden;
    }

    .visualizer-bar {
      width: 4px;
      background: linear-gradient(to top, var(--accent), var(--accent-hover));
      border-radius: 2px;
      transition: height 0.1s ease-out;
      min-height: 4px;
    }

    /* Footer */
    .footer {
      margin-top: auto;
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app {
        padding: 16px;
      }

      .header h1 {
        font-size: 1.75rem;
      }

      .controls-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .chord-card .chord-name {
        font-size: 1.25rem;
      }

      .btn {
        padding: 12px 20px;
        font-size: 0.875rem;
      }

      .transport {
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      .controls-grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .chords-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Loading State */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <h1>ðŸŽµ Chord Generator</h1>
      <p>Create modern progressions for improvisation & composition</p>
    </header>

    <!-- Controls -->
    <div class="controls-grid">
      <div class="control-group">
        <label>Key</label>
        <select id="keySelect">
          <option value="C">C</option>
          <option value="C#">C# / Db</option>
          <option value="D">D</option>
          <option value="D#">D# / Eb</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="F#">F# / Gb</option>
          <option value="G">G</option>
          <option value="G#">G# / Ab</option>
          <option value="A">A</option>
          <option value="A#">A# / Bb</option>
          <option value="B">B</option>
        </select>
      </div>

      <div class="control-group">
        <label>Mode</label>
        <select id="modeSelect">
          <option value="major">Major</option>
          <option value="minor">Minor</option>
          <option value="dorian">Dorian</option>
          <option value="mixolydian">Mixolydian</option>
          <option value="lydian">Lydian</option>
        </select>
      </div>

      <div class="control-group">
        <label>Style</label>
        <select id="styleSelect">
          <option value="modern">Modern Pop</option>
          <option value="electronic">Electronic</option>
          <option value="ambient">Ambient</option>
          <option value="jazzy">Neo Soul / Jazzy</option>
          <option value="lofi">Lo-Fi</option>
          <option value="cinematic">Cinematic</option>
        </select>
      </div>

      <div class="control-group">
        <label>BPM</label>
        <input type="number" id="bpmInput" value="90" min="40" max="200">
      </div>

      <div class="control-group">
        <label>Time Signature</label>
        <select id="timeSignature">
          <option value="4">4/4</option>
          <option value="3">3/4</option>
          <option value="6">6/8</option>
        </select>
      </div>

      <div class="control-group">
        <label>Bars per Chord</label>
        <select id="barsPerChord">
          <option value="1">1 Bar</option>
          <option value="2" selected>2 Bars</option>
          <option value="4">4 Bars</option>
        </select>
      </div>
    </div>

    <!-- Chord Display -->
    <div class="chord-display">
      <div class="chord-display-header">
        <span class="chord-display-title">Current Progression</span>
        <span class="progression-info" id="progressionInfo">4 chords â€¢ 8 bars</span>
      </div>
      <div class="chords-container" id="chordsContainer">
        <div class="chord-card">
          <div class="chord-name">â€”</div>
          <div class="chord-type">Press Generate</div>
          <div class="beat-indicator"></div>
        </div>
      </div>
    </div>

    <!-- Visualizer -->
    <div class="visualizer" id="visualizer"></div>

    <!-- Transport -->
    <div class="transport">
      <button class="btn btn-primary" id="playBtn">
        <svg class="btn-icon" id="playIcon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
        <span id="playBtnText">Play</span>
      </button>
      <button class="btn btn-secondary" id="generateBtn">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 4v6h-6M1 20v-6h6"/>
          <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
        </svg>
        Generate
      </button>
    </div>

    <!-- Sound Settings -->
    <div class="sound-settings">
      <div class="settings-title">Sound Settings</div>
      <div class="settings-grid">
        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Synth Sound</span>
          </div>
          <select id="synthType" style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 8px; color: var(--text-primary); width: 100%;">
            <option value="pad">Warm Pad</option>
            <option value="pluck">Pluck</option>
            <option value="keys">Electric Piano</option>
            <option value="strings">Strings</option>
          </select>
        </div>

        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Chord Volume</span>
            <span class="slider-value" id="chordVolValue">70%</span>
          </div>
          <input type="range" id="chordVolume" min="0" max="100" value="70">
        </div>

        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Drum Volume</span>
            <span class="slider-value" id="drumVolValue">60%</span>
          </div>
          <input type="range" id="drumVolume" min="0" max="100" value="60">
        </div>

        <div class="slider-group">
          <div class="slider-header">
            <span class="slider-label">Reverb</span>
            <span class="slider-value" id="reverbValue">40%</span>
          </div>
          <input type="range" id="reverbAmount" min="0" max="100" value="40">
        </div>
      </div>

      <div style="margin-top: 16px;">
        <div class="toggle-group">
          <span class="toggle-label">Enable Drums</span>
          <div class="toggle active" id="drumsToggle"></div>
        </div>
        <div class="toggle-group">
          <span class="toggle-label">Metronome Click</span>
          <div class="toggle" id="metronomeToggle"></div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <p>Chord Generator â€¢ Web Audio API â€¢ PWA Ready</p>
    </footer>
  </div>

  <script>
    // ============================================
    // CHORD GENERATOR - WEB AUDIO APPLICATION
    // ============================================

    // Audio Context
    let audioCtx = null;
    let masterGain = null;
    let reverbNode = null;
    let analyser = null;

    // State
    let isPlaying = false;
    let currentChordIndex = 0;
    let currentBeat = 0;
    let schedulerTimer = null;
    let nextNoteTime = 0;
    let currentProgression = [];

    // Settings
    const settings = {
      bpm: 90,
      timeSignature: 4,
      barsPerChord: 2,
      drumsEnabled: true,
      metronomeEnabled: false,
      chordVolume: 0.7,
      drumVolume: 0.6,
      reverbAmount: 0.4,
      synthType: 'pad'
    };

    // Note frequencies (A4 = 440Hz)
    const NOTE_FREQUENCIES = {
      'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13,
      'E': 329.63, 'F': 349.23, 'F#': 369.99, 'G': 392.00,
      'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
    };

    const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

    // Scale patterns (semitones from root)
    const SCALES = {
      major: [0, 2, 4, 5, 7, 9, 11],
      minor: [0, 2, 3, 5, 7, 8, 10],
      dorian: [0, 2, 3, 5, 7, 9, 10],
      mixolydian: [0, 2, 4, 5, 7, 9, 10],
      lydian: [0, 2, 4, 6, 7, 9, 11]
    };

    // Chord types with intervals
    const CHORD_TYPES = {
      'maj': [0, 4, 7],
      'min': [0, 3, 7],
      'maj7': [0, 4, 7, 11],
      'min7': [0, 3, 7, 10],
      'dom7': [0, 4, 7, 10],
      '7sus4': [0, 5, 7, 10],
      'add9': [0, 4, 7, 14],
      'madd9': [0, 3, 7, 14],
      'maj9': [0, 4, 7, 11, 14],
      'min9': [0, 3, 7, 10, 14],
      'sus2': [0, 2, 7],
      'sus4': [0, 5, 7],
      '6': [0, 4, 7, 9],
      'min6': [0, 3, 7, 9],
      'dim': [0, 3, 6],
      'dim7': [0, 3, 6, 9],
      'm7b5': [0, 3, 6, 10],
      'aug': [0, 4, 8]
    };

    // Style-specific chord progressions templates
    const STYLE_PROGRESSIONS = {
      modern: {
        major: [
          [{deg: 1, type: 'maj'}, {deg: 5, type: 'maj'}, {deg: 6, type: 'min'}, {deg: 4, type: 'maj'}],
          [{deg: 1, type: 'maj'}, {deg: 4, type: 'add9'}, {deg: 6, type: 'min7'}, {deg: 5, type: 'sus4'}],
          [{deg: 6, type: 'min'}, {deg: 4, type: 'maj'}, {deg: 1, type: 'maj'}, {deg: 5, type: 'maj'}],
          [{deg: 1, type: 'maj7'}, {deg: 3, type: 'min7'}, {deg: 4, type: 'maj7'}, {deg: 5, type: 'dom7'}]
        ],
        minor: [
          [{deg: 1, type: 'min'}, {deg: 6, type: 'maj'}, {deg: 3, type: 'maj'}, {deg: 7, type: 'maj'}],
          [{deg: 1, type: 'min7'}, {deg: 4, type: 'min7'}, {deg: 6, type: 'maj7'}, {deg: 5, type: 'dom7'}],
          [{deg: 1, type: 'min'}, {deg: 7, type: 'maj'}, {deg: 6, type: 'maj'}, {deg: 7, type: 'maj'}],
          [{deg: 6, type: 'maj'}, {deg: 7, type: 'maj'}, {deg: 1, type: 'min'}, {deg: 1, type: 'min'}]
        ]
      },
      electronic: {
        major: [
          [{deg: 1, type: 'sus2'}, {deg: 4, type: 'sus2'}, {deg: 5, type: 'sus4'}, {deg: 1, type: 'maj'}],
          [{deg: 1, type: 'maj'}, {deg: 1, type: 'maj'}, {deg: 4, type: 'maj'}, {deg: 4, type: 'maj'}],
          [{deg: 6, type: 'min7'}, {deg: 4, type: 'add9'}, {deg: 1, type: 'maj'}, {deg: 5, type: '7sus4'}],
          [{deg: 1, type: 'add9'}, {deg: 5, type: 'sus4'}, {deg: 6, type: 'min'}, {deg: 4, type: 'add9'}]
        ],
        minor: [
          [{deg: 1, type: 'min'}, {deg: 1, type: 'min'}, {deg: 6, type: 'maj'}, {deg: 7, type: 'maj'}],
          [{deg: 1, type: 'madd9'}, {deg: 4, type: 'min'}, {deg: 6, type: 'maj'}, {deg: 7, type: 'sus2'}],
          [{deg: 1, type: 'min7'}, {deg: 3, type: 'maj'}, {deg: 6, type: 'maj'}, {deg: 7, type: 'maj'}],
          [{deg: 1, type: 'min'}, {deg: 7, type: 'sus2'}, {deg: 6, type: 'sus2'}, {deg: 4, type: 'min'}]
        ]
      },
      ambient: {
        major: [
          [{deg: 1, type: 'maj9'}, {deg: 4, type: 'maj7'}, {deg: 2, type: 'min9'}, {deg: 5, type: '7sus4'}],
          [{deg: 1, type: 'add9'}, {deg: 6, type: 'min9'}, {deg: 4, type: 'maj9'}, {deg: 5, type: 'sus4'}],
          [{deg: 1, type: 'maj7'}, {deg: 3, type: 'min7'}, {deg: 6, type: 'min9'}, {deg: 4, type: 'maj9'}],
          [{deg: 4, type: 'maj9'}, {deg: 1, type: 'maj7'}, {deg: 5, type: 'sus4'}, {deg: 6, type: 'min9'}]
        ],
        minor: [
          [{deg: 1, type: 'min9'}, {deg: 4, type: 'min7'}, {deg: 6, type: 'maj9'}, {deg: 3, type: 'maj7'}],
          [{deg: 1, type: 'min7'}, {deg: 7, type: 'maj7'}, {deg: 6, type: 'maj9'}, {deg: 4, type: 'min9'}],
          [{deg: 6, type: 'maj9'}, {deg: 3, type: 'maj7'}, {deg: 7, type: 'maj'}, {deg: 1, type: 'min9'}],
          [{deg: 1, type: 'madd9'}, {deg: 6, type: 'maj7'}, {deg: 7, type: 'sus2'}, {deg: 4, type: 'min7'}]
        ]
      },
      jazzy: {
        major: [
          [{deg: 2, type: 'min9'}, {deg: 5, type: 'dom7'}, {deg: 1, type: 'maj9'}, {deg: 6, type: 'min7'}],
          [{deg: 1, type: 'maj9'}, {deg: 4, type: 'maj7'}, {deg: 3, type: 'min7'}, {deg: 6, type: 'dom7'}],
          [{deg: 1, type: '6'}, {deg: 2, type: 'min7'}, {deg: 5, type: 'dom7'}, {deg: 1, type: 'maj7'}],
          [{deg: 3, type: 'min7'}, {deg: 6, type: 'dom7'}, {deg: 2, type: 'min7'}, {deg: 5, type: 'dom7'}]
        ],
        minor: [
          [{deg: 1, type: 'min9'}, {deg: 4, type: 'min7'}, {deg: 5, type: 'dom7'}, {deg: 1, type: 'min6'}],
          [{deg: 2, type: 'm7b5'}, {deg: 5, type: 'dom7'}, {deg: 1, type: 'min9'}, {deg: 6, type: 'maj7'}],
          [{deg: 1, type: 'min7'}, {deg: 7, type: 'dom7'}, {deg: 3, type: 'maj7'}, {deg: 6, type: 'min7'}],
          [{deg: 1, type: 'min9'}, {deg: 4, type: 'dom7'}, {deg: 7, type: 'maj7'}, {deg: 3, type: '6'}]
        ]
      },
      lofi: {
        major: [
          [{deg: 2, type: 'min7'}, {deg: 5, type: 'dom7'}, {deg: 1, type: 'maj7'}, {deg: 1, type: 'maj7'}],
          [{deg: 1, type: 'maj7'}, {deg: 6, type: 'min7'}, {deg: 2, type: 'min7'}, {deg: 5, type: '7sus4'}],
          [{deg: 4, type: 'maj7'}, {deg: 3, type: 'min7'}, {deg: 2, type: 'min7'}, {deg: 1, type: 'maj7'}],
          [{deg: 1, type: 'maj9'}, {deg: 4, type: 'maj7'}, {deg: 6, type: 'min9'}, {deg: 5, type: 'dom7'}]
        ],
        minor: [
          [{deg: 1, type: 'min9'}, {deg: 4, type: 'min7'}, {deg: 7, type: 'maj7'}, {deg: 3, type: 'maj7'}],
          [{deg: 6, type: 'maj7'}, {deg: 7, type: 'maj7'}, {deg: 1, type: 'min7'}, {deg: 4, type: 'min7'}],
          [{deg: 1, type: 'min7'}, {deg: 6, type: 'maj9'}, {deg: 3, type: 'maj7'}, {deg: 7, type: 'dom7'}],
          [{deg: 2, type: 'm7b5'}, {deg: 5, type: 'dom7'}, {deg: 1, type: 'min9'}, {deg: 4, type: 'min7'}]
        ]
      },
      cinematic: {
        major: [
          [{deg: 1, type: 'maj'}, {deg: 3, type: 'min'}, {deg: 4, type: 'maj'}, {deg: 1, type: 'maj'}],
          [{deg: 1, type: 'sus2'}, {deg: 5, type: 'sus4'}, {deg: 6, type: 'min'}, {deg: 4, type: 'add9'}],
          [{deg: 6, type: 'min'}, {deg: 3, type: 'min'}, {deg: 4, type: 'maj'}, {deg: 1, type: 'sus2'}],
          [{deg: 1, type: 'add9'}, {deg: 6, type: 'min'}, {deg: 4, type: 'maj'}, {deg: 5, type: 'sus4'}]
        ],
        minor: [
          [{deg: 1, type: 'min'}, {deg: 6, type: 'maj'}, {deg: 3, type: 'maj'}, {deg: 4, type: 'min'}],
          [{deg: 1, type: 'madd9'}, {deg: 7, type: 'maj'}, {deg: 6, type: 'sus2'}, {deg: 6, type: 'maj'}],
          [{deg: 4, type: 'min'}, {deg: 1, type: 'min'}, {deg: 6, type: 'maj'}, {deg: 7, type: 'sus2'}],
          [{deg: 1, type: 'min'}, {deg: 5, type: 'min'}, {deg: 6, type: 'maj'}, {deg: 7, type: 'maj'}]
        ]
      }
    };

    // Drum patterns
    const DRUM_PATTERNS = {
      '4': { // 4/4
        kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
        snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
        hihat: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
        openHat: [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1]
      },
      '3': { // 3/4
        kick: [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
        snare: [0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0],
        hihat: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
        openHat: [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1]
      },
      '6': { // 6/8
        kick: [1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0],
        snare: [0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0],
        hihat: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
        openHat: [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1]
      }
    };

    // ============================================
    // INITIALIZATION
    // ============================================

    function initAudio() {
      if (audioCtx) return;
      
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      
      // Master gain
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.8;
      
      // Analyser for visualizer
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      
      // Reverb
      reverbNode = createReverb();
      
      // Routing
      masterGain.connect(analyser);
      analyser.connect(audioCtx.destination);
      
      initVisualizer();
    }

    function createReverb() {
      const convolver = audioCtx.createConvolver();
      const rate = audioCtx.sampleRate;
      const length = rate * 2;
      const decay = 2;
      const impulse = audioCtx.createBuffer(2, length, rate);
      
      for (let channel = 0; channel < 2; channel++) {
        const channelData = impulse.getChannelData(channel);
        for (let i = 0; i < length; i++) {
          channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
        }
      }
      
      convolver.buffer = impulse;
      return convolver;
    }

    // ============================================
    // SOUND SYNTHESIS
    // ============================================

    function playChord(frequencies, time, duration) {
      const synthType = settings.synthType;
      
      frequencies.forEach((freq, i) => {
        switch (synthType) {
          case 'pad':
            playPadNote(freq, time, duration, i);
            break;
          case 'pluck':
            playPluckNote(freq, time, duration, i);
            break;
          case 'keys':
            playKeysNote(freq, time, duration, i);
            break;
          case 'strings':
            playStringsNote(freq, time, duration, i);
            break;
        }
      });
    }

    function playPadNote(freq, time, duration, voiceIndex) {
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      
      osc1.type = 'sawtooth';
      osc2.type = 'triangle';
      osc1.frequency.value = freq;
      osc2.frequency.value = freq * 1.002; // Slight detune
      
      filter.type = 'lowpass';
      filter.frequency.value = 2000;
      filter.Q.value = 1;
      
      const vol = settings.chordVolume * 0.15;
      gain.gain.setValueAtTime(0, time);
      gain.gain.linearRampToValueAtTime(vol, time + 0.3);
      gain.gain.setValueAtTime(vol, time + duration - 0.5);
      gain.gain.linearRampToValueAtTime(0, time + duration);
      
      osc1.connect(filter);
      osc2.connect(filter);
      filter.connect(gain);
      
      // Dry/wet mix for reverb
      const dryGain = audioCtx.createGain();
      const wetGain = audioCtx.createGain();
      dryGain.gain.value = 1 - settings.reverbAmount;
      wetGain.gain.value = settings.reverbAmount;
      
      gain.connect(dryGain);
      gain.connect(wetGain);
      dryGain.connect(masterGain);
      wetGain.connect(reverbNode);
      reverbNode.connect(masterGain);
      
      osc1.start(time);
      osc2.start(time);
      osc1.stop(time + duration);
      osc2.stop(time + duration);
    }

    function playPluckNote(freq, time, duration, voiceIndex) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      
      osc.type = 'triangle';
      osc.frequency.value = freq;
      
      filter.type = 'lowpass';
      filter.frequency.setValueAtTime(4000, time);
      filter.frequency.exponentialRampToValueAtTime(500, time + 0.5);
      
      const vol = settings.chordVolume * 0.3;
      gain.gain.setValueAtTime(vol, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + Math.min(duration, 1.5));
      
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(masterGain);
      
      osc.start(time);
      osc.stop(time + duration);
    }

    function playKeysNote(freq, time, duration, voiceIndex) {
      const osc = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      
      osc.type = 'sine';
      osc2.type = 'triangle';
      osc.frequency.value = freq;
      osc2.frequency.value = freq * 2;
      
      filter.type = 'lowpass';
      filter.frequency.value = 3000;
      
      const vol = settings.chordVolume * 0.2;
      gain.gain.setValueAtTime(vol, time);
      gain.gain.setValueAtTime(vol * 0.7, time + 0.1);
      gain.gain.linearRampToValueAtTime(0, time + duration - 0.1);
      
      osc.connect(filter);
      osc2.connect(filter);
      filter.connect(gain);
      
      const dryGain = audioCtx.createGain();
      const wetGain = audioCtx.createGain();
      dryGain.gain.value = 1 - settings.reverbAmount * 0.5;
      wetGain.gain.value = settings.reverbAmount * 0.5;
      
      gain.connect(dryGain);
      gain.connect(wetGain);
      dryGain.connect(masterGain);
      wetGain.connect(reverbNode);
      reverbNode.connect(masterGain);
      
      osc.start(time);
      osc2.start(time);
      osc.stop(time + duration);
      osc2.stop(time + duration);
    }

    function playStringsNote(freq, time, duration, voiceIndex) {
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const osc3 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      
      osc1.type = 'sawtooth';
      osc2.type = 'sawtooth';
      osc3.type = 'sawtooth';
      osc1.frequency.value = freq;
      osc2.frequency.value = freq * 1.003;
      osc3.frequency.value = freq * 0.997;
      
      filter.type = 'lowpass';
      filter.frequency.value = 1500;
      filter.Q.value = 0.5;
      
      const vol = settings.chordVolume * 0.1;
      gain.gain.setValueAtTime(0, time);
      gain.gain.linearRampToValueAtTime(vol, time + 0.4);
      gain.gain.setValueAtTime(vol, time + duration - 0.6);
      gain.gain.linearRampToValueAtTime(0, time + duration);
      
      osc1.connect(filter);
      osc2.connect(filter);
      osc3.connect(filter);
      filter.connect(gain);
      
      const wetGain = audioCtx.createGain();
      wetGain.gain.value = settings.reverbAmount * 0.8;
      gain.connect(masterGain);
      gain.connect(wetGain);
      wetGain.connect(reverbNode);
      reverbNode.connect(masterGain);
      
      osc1.start(time);
      osc2.start(time);
      osc3.start(time);
      osc1.stop(time + duration);
      osc2.stop(time + duration);
      osc3.stop(time + duration);
    }

    // ============================================
    // DRUMS
    // ============================================

    function playKick(time) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      
      osc.frequency.setValueAtTime(150, time);
      osc.frequency.exponentialRampToValueAtTime(40, time + 0.1);
      
      const vol = settings.drumVolume * 0.8;
      gain.gain.setValueAtTime(vol, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + 0.3);
      
      osc.connect(gain);
      gain.connect(masterGain);
      
      osc.start(time);
      osc.stop(time + 0.3);
    }

    function playSnare(time) {
      // Noise
      const bufferSize = audioCtx.sampleRate * 0.2;
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
      }
      
      const noise = audioCtx.createBufferSource();
      noise.buffer = buffer;
      
      const noiseFilter = audioCtx.createBiquadFilter();
      noiseFilter.type = 'highpass';
      noiseFilter.frequency.value = 1000;
      
      const noiseGain = audioCtx.createGain();
      const vol = settings.drumVolume * 0.4;
      noiseGain.gain.setValueAtTime(vol, time);
      noiseGain.gain.exponentialRampToValueAtTime(0.001, time + 0.15);
      
      noise.connect(noiseFilter);
      noiseFilter.connect(noiseGain);
      noiseGain.connect(masterGain);
      
      // Tone
      const osc = audioCtx.createOscillator();
      const oscGain = audioCtx.createGain();
      osc.frequency.value = 180;
      oscGain.gain.setValueAtTime(vol * 0.5, time);
      oscGain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
      
      osc.connect(oscGain);
      oscGain.connect(masterGain);
      
      noise.start(time);
      osc.start(time);
      osc.stop(time + 0.2);
    }

    function playHiHat(time, open = false) {
      const bufferSize = audioCtx.sampleRate * (open ? 0.3 : 0.05);
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
      }
      
      const noise = audioCtx.createBufferSource();
      noise.buffer = buffer;
      
      const filter = audioCtx.createBiquadFilter();
      filter.type = 'highpass';
      filter.frequency.value = 7000;
      
      const gain = audioCtx.createGain();
      const vol = settings.drumVolume * (open ? 0.25 : 0.2);
      gain.gain.setValueAtTime(vol, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + (open ? 0.2 : 0.05));
      
      noise.connect(filter);
      filter.connect(gain);
      gain.connect(masterGain);
      
      noise.start(time);
    }

    function playMetronome(time, accent) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      
      osc.frequency.value = accent ? 1000 : 800;
      osc.type = 'sine';
      
      gain.gain.setValueAtTime(0.1, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
      
      osc.connect(gain);
      gain.connect(masterGain);
      
      osc.start(time);
      osc.stop(time + 0.05);
    }

    // ============================================
    // CHORD GENERATION
    // ============================================

    function getScaleNotes(rootNote, mode) {
      const rootIndex = NOTES.indexOf(rootNote);
      const scale = SCALES[mode] || SCALES.major;
      return scale.map(interval => NOTES[(rootIndex + interval) % 12]);
    }

    function getChordNotes(rootNote, chordType, octave = 3) {
      const rootIndex = NOTES.indexOf(rootNote);
      const intervals = CHORD_TYPES[chordType] || CHORD_TYPES.maj;
      
      return intervals.map(interval => {
        const noteIndex = (rootIndex + interval) % 12;
        const noteOctave = octave + Math.floor((rootIndex + interval) / 12);
        const note = NOTES[noteIndex];
        const freq = NOTE_FREQUENCIES[note] * Math.pow(2, noteOctave - 4);
        return freq;
      });
    }

    function generateProgression() {
      const key = document.getElementById('keySelect').value;
      const mode = document.getElementById('modeSelect').value;
      const style = document.getElementById('styleSelect').value;
      
      // Get mode family for progression selection
      const modeFamily = (mode === 'minor' || mode === 'dorian') ? 'minor' : 'major';
      
      // Get progressions for style
      const styleProgs = STYLE_PROGRESSIONS[style] || STYLE_PROGRESSIONS.modern;
      const progressions = styleProgs[modeFamily];
      
      // Random selection
      const selectedProg = progressions[Math.floor(Math.random() * progressions.length)];
      
      // Get scale notes
      const scaleNotes = getScaleNotes(key, mode);
      
      // Build chord objects
      currentProgression = selectedProg.map(chord => {
        const rootNote = scaleNotes[(chord.deg - 1) % 7];
        return {
          root: rootNote,
          type: chord.type,
          name: rootNote + formatChordType(chord.type),
          frequencies: getChordNotes(rootNote, chord.type, 3)
        };
      });
      
      updateChordDisplay();
      updateProgressionInfo();
    }

    function formatChordType(type) {
      const formats = {
        'maj': '',
        'min': 'm',
        'maj7': 'maj7',
        'min7': 'm7',
        'dom7': '7',
        '7sus4': '7sus4',
        'add9': 'add9',
        'madd9': 'madd9',
        'maj9': 'maj9',
        'min9': 'm9',
        'sus2': 'sus2',
        'sus4': 'sus4',
        '6': '6',
        'min6': 'm6',
        'dim': 'dim',
        'dim7': 'dim7',
        'm7b5': 'm7b5',
        'aug': 'aug'
      };
      return formats[type] || type;
    }

    // ============================================
    // PLAYBACK
    // ============================================

    function startPlayback() {
      initAudio();
      
      if (currentProgression.length === 0) {
        generateProgression();
      }
      
      isPlaying = true;
      currentChordIndex = 0;
      currentBeat = 0;
      nextNoteTime = audioCtx.currentTime + 0.1;
      
      updatePlayButton();
      scheduler();
    }

    function stopPlayback() {
      isPlaying = false;
      if (schedulerTimer) {
        clearTimeout(schedulerTimer);
      }
      updatePlayButton();
      clearActiveChord();
    }

    function scheduler() {
      if (!isPlaying) return;
      
      const secondsPerBeat = 60 / settings.bpm;
      const lookAhead = 0.1;
      const scheduleAheadTime = 0.2;
      
      while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
        scheduleNote(nextNoteTime);
        nextNoteTime += secondsPerBeat / 4; // 16th notes for drums
      }
      
      schedulerTimer = setTimeout(scheduler, lookAhead * 1000);
    }

    function scheduleNote(time) {
      const beatsPerBar = settings.timeSignature;
      const stepsPerBar = beatsPerBar * 4; // 16th notes
      const totalSteps = stepsPerBar * settings.barsPerChord;
      
      // Get drum pattern
      const pattern = DRUM_PATTERNS[settings.timeSignature] || DRUM_PATTERNS['4'];
      const patternStep = currentBeat % pattern.kick.length;
      
      // Play drums
      if (settings.drumsEnabled) {
        if (pattern.kick[patternStep]) playKick(time);
        if (pattern.snare[patternStep]) playSnare(time);
        if (pattern.hihat[patternStep]) playHiHat(time);
        if (pattern.openHat[patternStep]) playHiHat(time, true);
      }
      
      // Metronome
      if (settings.metronomeEnabled && currentBeat % 4 === 0) {
        playMetronome(time, currentBeat % (beatsPerBar * 4) === 0);
      }
      
      // Play chord on first beat of chord duration
      if (currentBeat % totalSteps === 0) {
        const chordDuration = (60 / settings.bpm) * beatsPerBar * settings.barsPerChord;
        const chord = currentProgression[currentChordIndex];
        playChord(chord.frequencies, time, chordDuration);
        
        // Update UI
        setTimeout(() => setActiveChord(currentChordIndex), (time - audioCtx.currentTime) * 1000);
      }
      
      // Advance
      currentBeat++;
      if (currentBeat >= totalSteps) {
        currentBeat = 0;
        currentChordIndex = (currentChordIndex + 1) % currentProgression.length;
      }
    }

    // ============================================
    // UI UPDATES
    // ============================================

    function updateChordDisplay() {
      const container = document.getElementById('chordsContainer');
      container.innerHTML = currentProgression.map((chord, i) => `
        <div class="chord-card" data-index="${i}" onclick="playChordPreview(${i})">
          <div class="chord-name">${chord.root}${formatChordType(chord.type)}</div>
          <div class="chord-type">${getChordTypeName(chord.type)}</div>
          <div class="beat-indicator"></div>
        </div>
      `).join('');
    }

    function getChordTypeName(type) {
      const names = {
        'maj': 'Major',
        'min': 'Minor',
        'maj7': 'Major 7',
        'min7': 'Minor 7',
        'dom7': 'Dominant 7',
        '7sus4': 'Dom 7sus4',
        'add9': 'Add 9',
        'madd9': 'Minor add9',
        'maj9': 'Major 9',
        'min9': 'Minor 9',
        'sus2': 'Sus 2',
        'sus4': 'Sus 4',
        '6': 'Major 6',
        'min6': 'Minor 6',
        'dim': 'Diminished',
        'dim7': 'Dim 7',
        'm7b5': 'Half-dim',
        'aug': 'Augmented'
      };
      return names[type] || type;
    }

    function updateProgressionInfo() {
      const info = document.getElementById('progressionInfo');
      const totalBars = currentProgression.length * settings.barsPerChord;
      info.textContent = `${currentProgression.length} chords â€¢ ${totalBars} bars`;
    }

    function setActiveChord(index) {
      document.querySelectorAll('.chord-card').forEach((card, i) => {
        card.classList.toggle('active', i === index);
      });
    }

    function clearActiveChord() {
      document.querySelectorAll('.chord-card').forEach(card => {
        card.classList.remove('active');
      });
    }

    function updatePlayButton() {
      const btn = document.getElementById('playBtn');
      const icon = document.getElementById('playIcon');
      const text = document.getElementById('playBtnText');
      
      if (isPlaying) {
        icon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
        text.textContent = 'Stop';
      } else {
        icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
        text.textContent = 'Play';
      }
    }

    function playChordPreview(index) {
      initAudio();
      const chord = currentProgression[index];
      if (chord) {
        playChord(chord.frequencies, audioCtx.currentTime, 1.5);
      }
    }

    // ============================================
    // VISUALIZER
    // ============================================

    function initVisualizer() {
      const container = document.getElementById('visualizer');
      container.innerHTML = '';
      
      const barCount = 32;
      for (let i = 0; i < barCount; i++) {
        const bar = document.createElement('div');
        bar.className = 'visualizer-bar';
        bar.style.height = '4px';
        container.appendChild(bar);
      }
      
      animateVisualizer();
    }

    function animateVisualizer() {
      if (!analyser) {
        requestAnimationFrame(animateVisualizer);
        return;
      }
      
      const bars = document.querySelectorAll('.visualizer-bar');
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);
      
      const step = Math.floor(bufferLength / bars.length);
      
      bars.forEach((bar, i) => {
        const value = dataArray[i * step];
        const height = Math.max(4, (value / 255) * 80);
        bar.style.height = height + 'px';
      });
      
      requestAnimationFrame(animateVisualizer);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
      // Generate initial progression
      generateProgression();
      
      // Play/Stop
      document.getElementById('playBtn').addEventListener('click', () => {
        if (isPlaying) {
          stopPlayback();
        } else {
          startPlayback();
        }
      });
      
      // Generate
      document.getElementById('generateBtn').addEventListener('click', () => {
        generateProgression();
        if (isPlaying) {
          currentChordIndex = 0;
          currentBeat = 0;
        }
      });
      
      // Settings changes
      document.getElementById('bpmInput').addEventListener('change', (e) => {
        settings.bpm = Math.max(40, Math.min(200, parseInt(e.target.value) || 90));
        e.target.value = settings.bpm;
      });
      
      document.getElementById('timeSignature').addEventListener('change', (e) => {
        settings.timeSignature = parseInt(e.target.value);
      });
      
      document.getElementById('barsPerChord').addEventListener('change', (e) => {
        settings.barsPerChord = parseInt(e.target.value);
        updateProgressionInfo();
      });
      
      document.getElementById('synthType').addEventListener('change', (e) => {
        settings.synthType = e.target.value;
      });
      
      // Volume sliders
      document.getElementById('chordVolume').addEventListener('input', (e) => {
        settings.chordVolume = e.target.value / 100;
        document.getElementById('chordVolValue').textContent = e.target.value + '%';
      });
      
      document.getElementById('drumVolume').addEventListener('input', (e) => {
        settings.drumVolume = e.target.value / 100;
        document.getElementById('drumVolValue').textContent = e.target.value + '%';
      });
      
      document.getElementById('reverbAmount').addEventListener('input', (e) => {
        settings.reverbAmount = e.target.value / 100;
        document.getElementById('reverbValue').textContent = e.target.value + '%';
      });
      
      // Toggles
      document.getElementById('drumsToggle').addEventListener('click', (e) => {
        settings.drumsEnabled = !settings.drumsEnabled;
        e.target.classList.toggle('active', settings.drumsEnabled);
      });
      
      document.getElementById('metronomeToggle').addEventListener('click', (e) => {
        settings.metronomeEnabled = !settings.metronomeEnabled;
        e.target.classList.toggle('active', settings.metronomeEnabled);
      });
      
      // Regenerate on key/mode/style change
      ['keySelect', 'modeSelect', 'styleSelect'].forEach(id => {
        document.getElementById(id).addEventListener('change', generateProgression);
      });
      
      // Initialize visualizer bars
      initVisualizer();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        if (isPlaying) {
          stopPlayback();
        } else {
          startPlayback();
        }
      }
      if (e.code === 'KeyR' && e.target.tagName !== 'INPUT') {
        generateProgression();
      }
    });
  </script>
</body>
</html>
